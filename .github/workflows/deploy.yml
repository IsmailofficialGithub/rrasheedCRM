name: Deploy to Production

on:
  push:
    branches: [ "main" ]

jobs:
  build_verification:
    name: Build Verification (CI)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./app

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './app/package-lock.json'

    - name: Install Dependencies
      run: npm ci

    - name: Build Project
      run: npm run build

  deploy_to_server:
    name: Deploy to Server (CD)
    needs: build_verification
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: SSH and Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        # key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          echo "Starting Deployment..."
          
          # Navigate to repository root
          cd ~/CRM || exit
          
          # Pull latest changes
          git pull origin main
          
          # Go to app directory
          cd app || exit
          
          # Install dependencies
          echo "Installing dependencies..."
          npm install
          
          # Build the application
          echo "Building application..."
          npm run build
          
          # Restart application (assuming PM2 is used, otherwise this might need adjustment)
          if command -v pm2 &> /dev/null; then
              echo "Restarting with PM2..."
              pm2 reload all || pm2 start npm --name "crm-app" -- start
              pm2 save
          else
              echo "PM2 not found. Build successful, but server process might not have restarted."
              echo "Consider installing PM2: npm install -g pm2"
          fi
          
          echo "Deployment Complete!"
